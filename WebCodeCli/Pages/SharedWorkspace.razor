@page "/shared-workspace/{ShareCode}"
@namespace WebCodeCli.Pages
@using WebCodeCli.Domain.Domain.Model
@using WebCodeCli.Components
@using WebCodeCli.Helpers
@using System.Text
@using System.Text.Json
@using Markdig
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>共享工作区</PageTitle>

<div class="flex flex-col h-screen bg-gray-50">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-8 h-8 bg-gray-900 rounded-lg">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                </svg>
            </div>
            <div>
                <h1 class="font-semibold text-gray-800">共享工作区</h1>
                @if (_sessionInfo != null)
                {
                    <p class="text-xs text-gray-500">@_sessionInfo.Title</p>
                }
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                只读模式
            </span>
            <button @onclick="GoBack" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="返回">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- 主要内容区域 -->
    @if (_isLoading)
    {
        <div class="flex-1 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-4 text-gray-500">正在加载工作区...</p>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(_error))
    {
        <div class="flex-1 flex items-center justify-center">
            <div class="text-center max-w-md">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-semibold text-gray-800 mb-2">加载失败</h2>
                <p class="text-gray-500 mb-6">@_error</p>
                <button @onclick="Reload" class="px-6 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors">
                    重新加载
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="flex-1 flex overflow-hidden">
            <!-- 左侧：文件树 + 聊天记录 -->
            <div class="w-80 border-r border-gray-200 bg-white flex flex-col">
                <!-- Tab 切换 -->
                <div class="border-b border-gray-200">
                    <div class="flex">
                        <button @onclick='() => _activeTab = "files"'
                                class="flex-1 px-4 py-3 text-sm font-medium @(_activeTab == "files" ? "text-gray-900 border-b-2 border-gray-900" : "text-gray-500 hover:text-gray-700")">
                            <span class="flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                </svg>
                                工作区文件
                            </span>
                        </button>
                        <button @onclick='() => _activeTab = "chat"'
                                class="flex-1 px-4 py-3 text-sm font-medium @(_activeTab == "chat" ? "text-gray-900 border-b-2 border-gray-900" : "text-gray-500 hover:text-gray-700")">
                            <span class="flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                聊天记录
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Tab 内容 -->
                <div class="flex-1 overflow-auto">
                    @if (_activeTab == "files")
                    {
                        <!-- 文件树 -->
                        @if (_workspaceFiles.Any())
                        {
                            <div class="p-2">
                                @foreach (var node in _workspaceFiles)
                                {
                                    @RenderFileNode(node, 0)
                                }
                            </div>
                        }
                        else
                        {
                            <div class="p-4 text-center text-gray-500">
                                <svg class="w-12 h-12 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>工作区暂无文件</p>
                            </div>
                        }
                    }
                    else
                    {
                        <!-- 聊天记录 -->
                        @if (_sessionInfo?.Messages?.Any() == true)
                        {
                            <div class="p-2 sm:p-3 space-y-2 sm:space-y-3">
                                @foreach (var message in _sessionInfo.Messages)
                                {
                                    <div class="@(message.Role == "user" ? "bg-white border-l-4 border-gray-300 shadow-sm" : "bg-gray-50 border-l-4 border-blue-500 shadow-sm") rounded-lg sm:rounded-xl p-3 sm:p-4 hover:shadow-md transition-all border border-gray-100 overflow-hidden">
                                        <div class="flex justify-between items-center mb-2 sm:mb-3">
                                            <div class="flex items-center gap-1.5 sm:gap-2">
                                                @if (message.Role == "user")
                                                {
                                                    <div class="w-7 h-7 sm:w-8 sm:h-8 bg-gradient-to-br from-gray-600 to-gray-700 rounded-full flex items-center justify-center shadow-sm">
                                                        <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                        </svg>
                                                    </div>
                                                    <span class="font-bold text-sm sm:text-base text-gray-700">用户</span>
                                                }
                                                else
                                                {
                                                    <div class="w-7 h-7 sm:w-8 sm:h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-md">
                                                        <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                        </svg>
                                                    </div>
                                                    <span class="font-bold text-sm sm:text-base text-blue-700">助手</span>
                                                }
                                            </div>
                                            <span class="text-[10px] sm:text-xs text-gray-500 font-medium">@message.CreatedAt.ToString("HH:mm:ss")</span>
                                        </div>
                                        <div class="text-xs sm:text-sm">
                                            <div class="max-h-60 sm:max-h-96 overflow-y-auto overflow-x-hidden text-gray-700 leading-relaxed break-words prose prose-sm max-w-none">
                                                @((MarkupString)RenderMarkdown(message.Content))
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="p-8 text-center text-gray-400">
                                <div class="w-20 h-20 bg-gray-100 border border-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 shadow-md">
                                    <svg class="w-10 h-10 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                                <p class="text-base font-semibold text-gray-600">暂无聊天记录</p>
                                <p class="text-sm mt-2 text-gray-500">会话还没有任何对话消息</p>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- 右侧：内容预览区 -->
            <div class="flex-1 flex flex-col bg-white h-full">
                @if (_activeTab == "chat")
                {
                    <!-- 聊天记录展示区 -->
                    <div class="border-b border-gray-200 px-4 py-2 flex items-center gap-2 bg-gray-50">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span class="text-sm text-gray-600 font-medium">
                            @if (HasOutputEvents)
                            {
                                <text>输出结果 (@OutputEventCount 条事件)</text>
                            }
                            else
                            {
                                <text>聊天记录 (@ChatMessageCount 条消息)</text>
                            }
                        </span>
                    </div>

                    <!-- 内容列表 -->
                    <div class="flex-1 overflow-y-auto h-full">
                        @if (HasOutputEvents)
                        {
                            <!-- 使用通用输出结果组件 -->
                            <OutputResultPanel 
                                ContainerId="shared-output-container"
                                HasOutputEvents="true"
                                TotalEventCount="@OutputEventCount"
                                DisplayedEventCount="@OutputEventCount"
                                EventGroups="@ConvertOutputEventsToGroups()"
                                CopyLabel="复制"
                                OnToggleGroupCallback="HandleToggleOutputGroup"
                                IsGroupOpenFunc="@IsOutputGroupOpen" />
                        }
                        else if (_sessionInfo?.Messages?.Any() == true)
                        {
                            <div class="p-4 space-y-3 overflow-y-auto h-full">
                            <!-- 回退：显示聊天消息 -->
                            @foreach (var message in _sessionInfo.Messages)
                            {
                                <div class="@(message.Role == "user" ? "bg-white border-l-4 border-gray-300 shadow-sm" : "bg-gray-50 border-l-4 border-blue-500 shadow-sm") rounded-xl p-4 hover:shadow-md transition-all border border-gray-100 overflow-hidden">
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="flex items-center gap-2">
                                            @if (message.Role == "user")
                                            {
                                                <div class="w-8 h-8 bg-gradient-to-br from-gray-600 to-gray-700 rounded-full flex items-center justify-center shadow-sm">
                                                    <svg class="w-4.5 h-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                    </svg>
                                                </div>
                                                <span class="font-bold text-base text-gray-700">用户</span>
                                            }
                                            else
                                            {
                                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-md">
                                                    <svg class="w-4.5 h-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                    </svg>
                                                </div>
                                                <span class="font-bold text-base text-blue-700">助手</span>
                                            }
                                        </div>
                                        <span class="text-xs text-gray-500 font-medium">@message.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                    </div>
                                    <div class="text-sm text-gray-700 leading-relaxed break-words prose prose-sm max-w-none">
                                        @((MarkupString)RenderMarkdown(message.Content))
                                    </div>
                                </div>
                            }
                            </div>
                        }
                        else
                        {
                            <div class="flex-1 flex items-center justify-center h-full">
                                <div class="text-center text-gray-400">
                                    <div class="w-20 h-20 bg-gray-100 border border-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 shadow-md">
                                        <svg class="w-10 h-10 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                    <p class="text-base font-semibold text-gray-600">暂无聊天记录</p>
                                    <p class="text-sm mt-2 text-gray-500">会话还没有任何对话消息</p>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(_selectedFilePath))
                {
                    <!-- 文件路径 -->
                    <div class="border-b border-gray-200 px-4 py-2 flex items-center gap-2 bg-gray-50">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="text-sm text-gray-600 font-mono">@_selectedFilePath</span>
                    </div>

                    <!-- 文件内容预览 -->
                    <div class="flex-1 overflow-hidden h-full">
                        <FilePreviewPanel 
                            PreviewType="@_previewType"
                            FileName="@_selectedFilePath"
                            FileContent="@_fileContent"
                            Language="@_language"
                            ImageUrl="@_imagePreviewUrl"
                            HtmlUrl="@_htmlPreviewUrl"
                            OfficePreviewUrl="@_officePreviewUrl"
                            OfficePreviewError="@_officePreviewError"
                            IsLoadingOffice="@_isLoadingOffice"
                            IsLoading="@_isLoadingFile"
                            CodeElementId="shared-code-preview"
                            ShowLineNumbers="true"
                            FullHeight="true"
                            ContainerClass="h-full w-full" />
                    </div>
                }
                else
                {
                    <!-- 空状态 -->
                    <div class="flex-1 flex items-center justify-center h-full">
                        <div class="text-center text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-lg">选择文件以查看内容</p>
                            <p class="text-sm mt-1">从左侧文件树中选择一个文件</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string ShareCode { get; set; } = string.Empty;

    private string _accessToken = string.Empty;
    private bool _isLoading = true;
    private string _error = string.Empty;
    private string _activeTab = "files";

    private SharedSessionInfo? _sessionInfo;
    private List<FileNode> _workspaceFiles = new();
    private HashSet<string> _expandedFolders = new();

    private string _selectedFilePath = string.Empty;
    private string _fileContent = string.Empty;
    private bool _isLoadingFile = false;
    private FilePreviewPanel.FilePreviewType _previewType = FilePreviewPanel.FilePreviewType.None;
    private string _language = "plaintext";
    private string _imagePreviewUrl = string.Empty;
    private string _htmlPreviewUrl = string.Empty;
    private string _officePreviewUrl = string.Empty;
    private string _officePreviewError = string.Empty;
    private bool _isLoadingOffice = false;
    
    // 输出事件组折叠状态管理
    private readonly HashSet<string> _openOutputGroups = new();
    
    // 计算属性
    private bool HasOutputEvents => _sessionInfo?.OutputEvents?.Any() == true;
    private int OutputEventCount => _sessionInfo?.OutputEvents?.Count ?? 0;
    private int ChatMessageCount => _sessionInfo?.Messages?.Count ?? 0;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .DisableHtml()
        .Build();

    protected override async Task OnInitializedAsync()
    {
        await LoadAccessToken();
        if (!string.IsNullOrEmpty(_accessToken))
        {
            await EnsureShareCookieAsync();
        }
        
        if (string.IsNullOrEmpty(_accessToken))
        {
            // 未验证，跳转到验证页面
            NavigationManager.NavigateTo($"/share/{ShareCode}");
            return;
        }

        await LoadWorkspace();
    }

    private async Task LoadAccessToken()
    {
        try
        {
            _accessToken = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", $"share_token_{ShareCode}") ?? string.Empty;
        }
        catch
        {
            _accessToken = string.Empty;
        }
    }

    private async Task EnsureShareCookieAsync()
    {
        try
        {
            // 为 iframe 及其资源请求设置 Cookie（使用安全的方式，避免 eval）
            var cookieExpires = DateTime.UtcNow.AddHours(24).ToString("R");
            var cookieName = $"share_token_{ShareCode}";
            var cookieValue = Uri.EscapeDataString(_accessToken);
            await JSRuntime.InvokeVoidAsync("setShareCookie", cookieName, cookieValue, cookieExpires);
        }
        catch
        {
            // 忽略 Cookie 写入失败
        }
    }

    private async Task LoadWorkspace()
    {
        try
        {
            _isLoading = true;
            _error = string.Empty;
            StateHasChanged();

            // 并行加载会话信息和文件列表
            var sessionTask = LoadSessionInfo();
            var filesTask = LoadFiles();

            await Task.WhenAll(sessionTask, filesTask);
        }
        catch (Exception ex)
        {
            _error = $"加载失败: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadSessionInfo()
    {
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"/api/share/{ShareCode}/session");
            request.Headers.Add("X-Share-Token", _accessToken);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                _sessionInfo = await response.Content.ReadFromJsonAsync<SharedSessionInfo>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                // 令牌无效，清除并跳转
                await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", $"share_token_{ShareCode}");
                NavigationManager.NavigateTo($"/share/{ShareCode}");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                _error = $"加载会话失败: {error}";
            }
        }
        catch (Exception ex)
        {
            _error = $"加载会话失败: {ex.Message}";
        }
    }

    private async Task LoadFiles()
    {
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"/api/share/{ShareCode}/workspace/files");
            request.Headers.Add("X-Share-Token", _accessToken);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                _workspaceFiles = await response.Content.ReadFromJsonAsync<List<FileNode>>() ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载文件列表失败: {ex.Message}");
        }
    }

    private async Task SelectFile(FileNode node)
    {
        if (node.Type == "folder")
        {
            ToggleFolder(node.Path);
            StateHasChanged();
            return;
        }

        _selectedFilePath = node.Path;
        _isLoadingFile = true;
        _fileContent = string.Empty;
        _previewType = FilePreviewPanel.FilePreviewType.None;
        _language = "plaintext";
        _imagePreviewUrl = string.Empty;
        _htmlPreviewUrl = string.Empty;
        _officePreviewUrl = string.Empty;
        _officePreviewError = string.Empty;
        _isLoadingOffice = false;
        StateHasChanged();

        try
        {
            var ext = node.Extension?.ToLower() ?? "";
            
            // 使用组件的方法确定预览类型
            _previewType = FilePreviewPanel.GetPreviewTypeFromExtension(ext);
            
            // 对路径进行正确的编码：对路径的每个部分分别编码，保留斜杠
            var encodedPath = EncodePathForUrl(node.Path);
            
            // 检查是否为图片
            if (_previewType == FilePreviewPanel.FilePreviewType.Image)
            {
                _imagePreviewUrl = $"/api/share/{ShareCode}/workspace/file/{encodedPath}?token={Uri.EscapeDataString(_accessToken)}";
            }
            // 检查是否为 HTML
            else if (_previewType == FilePreviewPanel.FilePreviewType.Html)
            {
                _htmlPreviewUrl = $"/api/share/{ShareCode}/workspace/file/{encodedPath}?token={Uri.EscapeDataString(_accessToken)}";
            }
            // 检查是否为 Office 文档
            else if (_previewType == FilePreviewPanel.FilePreviewType.Office)
            {
                _isLoadingOffice = true;
                StateHasChanged();

                // 构建文件访问 URL
                var fileUrl = $"{NavigationManager.BaseUri.TrimEnd('/')}/api/share/{ShareCode}/workspace/file/{encodedPath}?token={Uri.EscapeDataString(_accessToken)}";
                
                // 生成 Office 预览 URL
                var (previewUrl, errorMessage) = FilePreviewPanel.GenerateOfficePreviewUrl(fileUrl, NavigationManager.BaseUri);
                _officePreviewUrl = previewUrl;
                _officePreviewError = errorMessage;
                
                _isLoadingOffice = false;
            }
            // 代码或文本文件
            else if (_previewType == FilePreviewPanel.FilePreviewType.Code || _previewType == FilePreviewPanel.FilePreviewType.Text)
            {
                // 文本文件，获取内容
                var request = new HttpRequestMessage(HttpMethod.Get, $"/api/share/{ShareCode}/workspace/file/{encodedPath}");
                request.Headers.Add("X-Share-Token", _accessToken);

                var response = await Http.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    _fileContent = await response.Content.ReadAsStringAsync();
                    
                    // 获取语言
                    _language = FilePreviewPanel.GetLanguageFromExtension(ext);
                    
                    // 对于 JSON 文件，尝试格式化
                    if (ext == ".json" && !string.IsNullOrEmpty(_fileContent))
                    {
                        _fileContent = FilePreviewPanel.FormatJsonContent(_fileContent);
                    }
                }
                else
                {
                    _fileContent = "无法加载文件内容";
                    _previewType = FilePreviewPanel.FilePreviewType.Text;
                }
            }
        }
        catch (Exception ex)
        {
            _fileContent = $"加载失败: {ex.Message}";
            _previewType = FilePreviewPanel.FilePreviewType.Text;
        }
        finally
        {
            _isLoadingFile = false;
            StateHasChanged();
        }
    }

    private void ToggleFolder(string path)
    {
        if (_expandedFolders.Contains(path))
        {
            _expandedFolders.Remove(path);
        }
        else
        {
            _expandedFolders.Add(path);
        }
    }

    private RenderFragment RenderFileNode(FileNode node, int level) => __builder =>
    {
        var paddingLeft = level * 16 + 8;
        var isExpanded = _expandedFolders.Contains(node.Path);
        var isSelected = _selectedFilePath == node.Path;

        <div class="@(isSelected ? "bg-gray-200" : "hover:bg-gray-50") rounded cursor-pointer transition-colors"
             style="padding-left: @(paddingLeft)px"
             @onclick="() => SelectFile(node)">
            <div class="flex items-center gap-2 py-1.5 pr-2">
                @if (node.Type == "folder")
                {
                    <svg class="w-4 h-4 text-gray-400 transition-transform @(isExpanded ? "rotate-90" : "")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                    </svg>
                }
                else
                {
                    <span class="w-4"></span>
                    @((MarkupString)GetFileIcon(node.Extension))
                }
                <span class="text-sm text-gray-700 truncate flex-1">@node.Name</span>
                @if (node.Type == "file" && node.Size > 0)
                {
                    <span class="text-xs text-gray-400">@FormatFileSize(node.Size)</span>
                }
            </div>
        </div>

        @if (node.Type == "folder" && isExpanded && node.Children != null)
        {
            @foreach (var child in node.Children)
            {
                @RenderFileNode(child, level + 1)
            }
        }
    };

    private string GetFileIcon(string? extension)
    {
        // SharedWorkspace 使用 w-4 h-4 固定大小,所以这里包装 FileIconHelper 的结果
        // FileIconHelper 已经使用 w-3.5 h-3.5 sm:w-4 sm:h-4,这里直接返回即可
        return FileIconHelper.GetFileIcon(extension);
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private string RenderMarkdown(string? content)
    {
        if (string.IsNullOrWhiteSpace(content))
        {
            return string.Empty;
        }

        try
        {
            return Markdown.ToHtml(content, _markdownPipeline);
        }
        catch
        {
            return System.Net.WebUtility.HtmlEncode(content);
        }
    }

    private bool IsJsonlContent(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
        {
            return false;
        }

        // 只要任意一行是 JSONL 事件，就视为 JSONL 内容
        var lines = content.Split('\n', StringSplitOptions.RemoveEmptyEntries);
        return lines.Any(line =>
        {
            var trimmed = line.Trim();
            return trimmed.StartsWith("{") && trimmed.Contains("\"type\":");
        });
    }

    private string RenderJsonlContent(string content)
    {
        var html = new StringBuilder();
        html.Append("<div class=\"space-y-2\">");

        var lines = content.Split('\n', StringSplitOptions.RemoveEmptyEntries);
        foreach (var line in lines)
        {
            var trimmedLine = line.Trim();
            if (string.IsNullOrEmpty(trimmedLine))
            {
                continue;
            }

            try
            {
                using var document = JsonDocument.Parse(trimmedLine);
                var root = document.RootElement;

                if (!root.TryGetProperty("type", out var typeElement))
                {
                    continue;
                }

                var eventType = typeElement.GetString() ?? string.Empty;
                var badgeClass = GetJsonlBadgeClass(eventType);
                var badgeLabel = GetJsonlBadgeLabel(eventType);

                html.Append("<div class=\"border border-gray-200 rounded-lg p-3 bg-white\">");
                html.Append($"<span class=\"{badgeClass} text-xs font-semibold px-2 py-0.5 rounded-full\">{badgeLabel}</span>");

                if (root.TryGetProperty("content", out var contentElement) && contentElement.ValueKind == JsonValueKind.String)
                {
                    var eventContent = contentElement.GetString();
                    if (!string.IsNullOrEmpty(eventContent))
                    {
                        html.Append($"<div class=\"mt-2 text-sm text-gray-700 whitespace-pre-wrap\">{System.Net.WebUtility.HtmlEncode(eventContent)}</div>");
                    }
                }

                html.Append("</div>");
            }
            catch (JsonException)
            {
                // 忽略无效的 JSON 行
                continue;
            }
        }

        html.Append("</div>");
        return html.ToString();
    }

    private string GetJsonlBadgeClass(string eventType)
    {
        return eventType switch
        {
            "thread.started" => "bg-primary-100 text-primary-700",
            "turn.started" => "bg-sky-100 text-sky-700",
            "turn.completed" => "bg-emerald-100 text-emerald-700",
            "turn.failed" => "bg-red-100 text-red-700",
            "item.started" => "bg-amber-100 text-amber-700",
            "item.updated" => "bg-blue-100 text-blue-700",
            "item.completed" => "bg-green-100 text-green-700",
            "error" => "bg-red-100 text-red-700",
            _ => "bg-gray-200 text-gray-700"
        };
    }

    private string GetJsonlBadgeLabel(string eventType)
    {
        return eventType switch
        {
            "thread.started" => "线程启动",
            "turn.started" => "交互开始",
            "turn.completed" => "交互完成",
            "turn.failed" => "交互失败",
            "item.started" => "节点开始",
            "item.updated" => "节点更新",
            "item.completed" => "节点完成",
            "error" => "错误",
            _ => eventType
        };
    }
    
    /// <summary>
    /// 将 OutputEventItem 转换为 OutputEventGroup
    /// </summary>
    private List<OutputEventGroup> ConvertOutputEventsToGroups()
    {
        if (_sessionInfo?.OutputEvents == null || !_sessionInfo.OutputEvents.Any())
        {
            return new List<OutputEventGroup>();
        }

        var groups = new List<OutputEventGroup>();
        OutputEventGroup? currentGroup = null;

        foreach (var evt in _sessionInfo.OutputEvents)
        {
            // 工具调用类型的事件需要分组
            var isToolEvent = evt.Type.StartsWith("tool_") || 
                            evt.Type == "command" || 
                            evt.Type.Contains("execution");

            if (isToolEvent)
            {
                // 如果是工具开始事件，创建新组
                if (evt.Type == "tool_use" || evt.Type == "tool_start" || evt.Type == "command")
                {
                    // 保存上一个组
                    if (currentGroup != null && currentGroup.Items.Any())
                    {
                        groups.Add(currentGroup);
                    }

                    // 创建新组
                    currentGroup = new OutputEventGroup
                    {
                        Id = $"group_{groups.Count}",
                        Kind = "command_execution",
                        Title = evt.Title ?? "工具调用",
                        IsCompleted = false,
                        IsCollapsible = true,
                        Items = new List<OutputEvent>()
                    };
                }

                // 添加事件到当前组
                if (currentGroup != null)
                {
                    currentGroup.Items.Add(new OutputEvent
                    {
                        Type = evt.Type,
                        Title = evt.Title,
                        Content = evt.Content ?? string.Empty,
                        ItemType = evt.ItemType,
                        Usage = evt.Usage != null ? new TokenUsage
                        {
                            InputTokens = evt.Usage.InputTokens,
                            CachedInputTokens = evt.Usage.CachedInputTokens,
                            OutputTokens = evt.Usage.OutputTokens,
                            TotalTokens = evt.Usage.InputTokens + evt.Usage.CachedInputTokens + evt.Usage.OutputTokens
                        } : null
                    });

                    // 如果是工具结束事件，标记组完成
                    if (evt.Type == "tool_result" || evt.Type == "tool_finish")
                    {
                        currentGroup.IsCompleted = true;
                    }
                }
            }
            else
            {
                // 保存上一个工具组
                if (currentGroup != null && currentGroup.Items.Any())
                {
                    groups.Add(currentGroup);
                    currentGroup = null;
                }

                // 非工具事件，创建单独的不可折叠组
                groups.Add(new OutputEventGroup
                {
                    Id = $"event_{groups.Count}",
                    Kind = "single",
                    Title = evt.Title,
                    IsCompleted = true,
                    IsCollapsible = false,
                    Items = new List<OutputEvent>
                    {
                        new OutputEvent
                        {
                            Type = evt.Type,
                            Title = evt.Title,
                            Content = evt.Content ?? string.Empty,
                            ItemType = evt.ItemType,
                            Usage = evt.Usage != null ? new TokenUsage
                            {
                                InputTokens = evt.Usage.InputTokens,
                                CachedInputTokens = evt.Usage.CachedInputTokens,
                                OutputTokens = evt.Usage.OutputTokens,
                                TotalTokens = evt.Usage.InputTokens + evt.Usage.CachedInputTokens + evt.Usage.OutputTokens
                            } : null
                        }
                    }
                });
            }
        }

        // 添加最后一个组
        if (currentGroup != null && currentGroup.Items.Any())
        {
            groups.Add(currentGroup);
        }

        return groups;
    }

    /// <summary>
    /// 处理输出事件组的折叠/展开
    /// </summary>
    private void HandleToggleOutputGroup((string groupId, bool defaultOpen) args)
    {
        if (_openOutputGroups.Contains(args.groupId))
        {
            _openOutputGroups.Remove(args.groupId);
        }
        else
        {
            _openOutputGroups.Add(args.groupId);
        }
        StateHasChanged();
    }

    /// <summary>
    /// 判断输出事件组是否展开
    /// </summary>
    private bool IsOutputGroupOpen(OutputEventGroup group)
    {
        // 如果没有被手动操作过，根据完成状态决定
        if (!_openOutputGroups.Contains(group.Id))
        {
            // 未完成的组默认展开
            return !group.IsCompleted;
        }
        // 已手动操作过的组,保持用户选择的状态
        return _openOutputGroups.Contains(group.Id);
    }

    private async Task Reload()
    {
        await LoadWorkspace();
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }

    /// <summary>
    /// 对文件路径进行 URL 编码，保留路径分隔符
    /// </summary>
    private string EncodePathForUrl(string path)
    {
        if (string.IsNullOrEmpty(path))
        {
            return string.Empty;
        }

        // 将路径按斜杠分割，对每个部分分别编码，然后重新组合
        var parts = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        var encodedParts = parts.Select(p => Uri.EscapeDataString(p));
        return string.Join("/", encodedParts);
    }

    private class SharedSessionInfo
    {
        public string SessionId { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string? ToolId { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? MessagesJson { get; set; }
        public string? WorkspacePath { get; set; }
        public bool IsWorkspaceValid { get; set; }
        public string? OutputEventsJson { get; set; }
        
        private List<ChatMessage>? _messages;
        public List<ChatMessage>? Messages 
        { 
            get 
            {
                if (_messages == null && !string.IsNullOrEmpty(MessagesJson))
                {
                    try
                    {
                        _messages = System.Text.Json.JsonSerializer.Deserialize<List<ChatMessage>>(MessagesJson);
                    }
                    catch
                    {
                        _messages = new List<ChatMessage>();
                    }
                }
                return _messages;
            }
        }
        
        private List<OutputEventItem>? _outputEvents;
        public List<OutputEventItem>? OutputEvents
        {
            get
            {
                if (_outputEvents == null && !string.IsNullOrEmpty(OutputEventsJson))
                {
                    try
                    {
                        _outputEvents = System.Text.Json.JsonSerializer.Deserialize<List<OutputEventItem>>(OutputEventsJson);
                    }
                    catch
                    {
                        _outputEvents = new List<OutputEventItem>();
                    }
                }
                return _outputEvents;
            }
        }
    }
    
    private class OutputEventItem
    {
        public string Type { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string? Content { get; set; }
        public string? ItemType { get; set; }
        public bool IsUnknown { get; set; }
        public OutputEventUsage? Usage { get; set; }
    }
    
    private class OutputEventUsage
    {
        public int InputTokens { get; set; }
        public int CachedInputTokens { get; set; }
        public int OutputTokens { get; set; }
    }

    private class FileNode
    {
        public string Name { get; set; } = string.Empty;
        public string Path { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public long Size { get; set; }
        public string? Extension { get; set; }
        public bool IsHtml { get; set; }
        public List<FileNode>? Children { get; set; }
    }
}
