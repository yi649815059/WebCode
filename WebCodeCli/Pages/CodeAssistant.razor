@page "/code-assistant"
@namespace WebCodeCli.Pages
@using WebCodeCli.Domain.Domain.Model
@using System.Text
@using WebCodeCli.Pages
@using WebCodeCli.Components
@using WebCodeCli.Helpers
@inject IJSRuntime JSRuntime

<PageTitle>@T("codeAssistant.title")</PageTitle>

<div id="code-assistant-split-container" class="flex flex-row h-screen bg-gray-50 overflow-hidden" @key="_currentLanguage">
    <!-- Activity Bar - IDE风格侧边图标菜单 (仅PC端显示) -->
    <ActivityBar ActiveItem="@_activeMenuItem"
                 OnItemChanged="HandleMenuItemChange"
                 ChatTitle="@T("activityBar.chat")"
                 SessionsTitle="@T("activityBar.sessions")"
                 TemplatesTitle="@T("templateLibrary.title")"
                 ProjectsTitle="@T("activityBar.projects")"
                 ContextTitle="@T("codeAssistant.contextManagement")"
                 TasksTitle="@T("activityBar.tasks")"
                 SettingsTitle="@T("activityBar.settings")" />

    <!-- SidePanel - 侧边面板容器 (仅PC端显示) -->
    <SidePanel Show="@_showSidePanel"
               ActiveView="@_activeMenuItem"
               Width="280"
               OnClose="CloseSidePanel"
               CloseText="@T("common.close")"
               SessionsTitle="@T("activityBar.sessions")"
               ContextTitle="@T("codeAssistant.contextManagement")"
               TasksTitle="@T("activityBar.tasks")"
               SettingsTitle="@T("activityBar.settings")"
               CreateTaskText="@T("scheduledTask.create")"
               LoadingText="@T("common.loading")"
               NoTasksText="@T("scheduledTask.noTasks")"
               NoTasksHintText="@T("scheduledTask.noTasksHint")"
               EnabledText="@T("scheduledTask.enabled")"
               DisabledText="@T("scheduledTask.disabled")"
               RunNowText="@T("scheduledTask.runNow")"
               EditText="@T("common.edit")"
               HistoryText="@T("scheduledTask.history")"
               DeleteText="@T("common.delete")"
               NextRunText="@T("scheduledTask.nextRun")"
               LastStatusText="@T("scheduledTask.lastStatus")"
               SuccessText="@T("scheduledTask.status.success")"
               FailedText="@T("scheduledTask.status.failed")"
               RunningText="@T("scheduledTask.status.running")"
               TimeoutText="@T("scheduledTask.status.timeout")"
               CancelledText="@T("scheduledTask.status.cancelled")"
               ManualText="@T("scheduledTask.trigger.manual")"
               ScheduledText="@T("scheduledTask.trigger.scheduled")"
               CancelText="@T("common.cancel")"
               DeleteConfirmTitle="@T("scheduledTask.deleteConfirmTitle")"
               DeleteConfirmMessage="@T("scheduledTask.deleteConfirmMessage")"
               ConfirmDeleteText="@T("common.delete")"
               CronExpressionTitleText="@T("scheduledTask.cronExpression")"
               CreateDialogTitleText="@T("scheduledTask.dialog.createTitle")"
               EditDialogTitleText="@T("scheduledTask.dialog.editTitle")"
               NameLabelText="@T("scheduledTask.dialog.nameLabel")"
               NamePlaceholderText="@T("scheduledTask.dialog.namePlaceholder")"
               DescriptionLabelText="@T("scheduledTask.dialog.descriptionLabel")"
               DescriptionPlaceholderText="@T("scheduledTask.dialog.descriptionPlaceholder")"
               ToolLabelText="@T("scheduledTask.dialog.toolLabel")"
               SelectToolText="@T("scheduledTask.dialog.selectTool")"
               PromptLabelText="@T("scheduledTask.dialog.promptLabel")"
               PromptPlaceholderText="@T("scheduledTask.dialog.promptPlaceholder")"
               SessionLabelText="@T("scheduledTask.dialog.sessionLabel")"
               NewSessionText="@T("scheduledTask.dialog.newSession")"
               SessionHintText="@T("scheduledTask.dialog.sessionHint")"
               CronLabelText="@T("scheduledTask.dialog.cronLabel")"
               SelectPresetText="@T("scheduledTask.dialog.selectPreset")"
               ValidateText="@T("scheduledTask.dialog.validate")"
               NextRunTimesText="@T("scheduledTask.dialog.nextRunTimes")"
               AdvancedSettingsText="@T("scheduledTask.dialog.advancedSettings")"
               TimeoutLabelText="@T("scheduledTask.dialog.timeoutLabel")"
               SecondsText="@T("scheduledTask.dialog.seconds")"
               TimeoutHintText="@T("scheduledTask.dialog.timeoutHint")"
               RetryLabelText="@T("scheduledTask.dialog.retryLabel")"
               RetryHintText="@T("scheduledTask.dialog.retryHint")"
               DialogEnabledLabelText="@T("scheduledTask.dialog.enabledLabel")"
               DialogEnabledHintText="@T("scheduledTask.dialog.enabledHint")"
               SaveText="@T("common.save")"
               CreateText="@T("scheduledTask.create")"
               CronValidText="@T("scheduledTask.dialog.cronValid")"
               CronInvalidText="@T("scheduledTask.dialog.cronInvalid")"
               CronValidateFailedText="@T("scheduledTask.dialog.cronValidateFailed")"
               ErrorNameRequiredText="@T("scheduledTask.dialog.errorNameRequired")"
               ErrorToolRequiredText="@T("scheduledTask.dialog.errorToolRequired")"
               ErrorPromptRequiredText="@T("scheduledTask.dialog.errorPromptRequired")"
               ErrorCronRequiredText="@T("scheduledTask.dialog.errorCronRequired")"
               ErrorCronInvalidText="@T("scheduledTask.dialog.errorCronInvalid")"
               SaveFailedText="@T("scheduledTask.dialog.saveFailed")"
               SaveFailedWithMessageText="@T("scheduledTask.dialog.saveFailedWithMessage")"
               HistoryTitleText="@T("scheduledTask.historyDialog.title")"
               ExecutionListText="@T("scheduledTask.historyDialog.executionList")"
               RefreshText="@T("common.refresh")"
               NoExecutionsText="@T("scheduledTask.historyDialog.noExecutions")"
               ExecutionDetailsText="@T("scheduledTask.historyDialog.details")"
               CancelExecutionText="@T("scheduledTask.historyDialog.cancelExecution")"
               StartTimeText="@T("scheduledTask.historyDialog.startTime")"
               EndTimeText="@T("scheduledTask.historyDialog.endTime")"
               DurationText="@T("scheduledTask.historyDialog.duration")"
               TriggerTypeText="@T("scheduledTask.historyDialog.triggerType")"
               ErrorText="@T("common.error")"
               OutputText="@T("scheduledTask.historyDialog.output")"
               CopyText="@T("common.copy")"
               WrapTextText="@T("scheduledTask.historyDialog.wrapText")"
               NoOutputText="@T("scheduledTask.historyDialog.noOutput")"
               SelectExecutionHintText="@T("scheduledTask.historyDialog.selectExecutionHint")"
               OnError="@HandleSidePanelError">
        <SessionsContent>
            <SessionListPanel Show="true"
                              Embedded="true"
                              ShowHeader="false"
                              Sessions="@_sessions"
                              SelectedSessionIds="@_selectedSessionIds"
                              IsMultiSelectMode="@_isSessionMultiSelectMode"
                              IsLoadingSessions="@_isLoadingSessions"
                              IsLoadingSession="@_isLoadingSession"
                              CurrentSessionId="@(_currentSession?.SessionId ?? string.Empty)"
                              TitleText="@T("codeAssistant.sessionHistory")"
                              CloseText="@T("common.close")"
                              DeselectAllText="@T("codeAssistant.deselectAll")"
                              SelectAllText="@T("common.selectAll")"
                              BatchDeleteText="@T("codeAssistant.batchDelete")"
                              CancelText="@T("common.cancel")"
                              NewSessionText="@T("codeAssistant.newSession")"
                              MultiSelectText="@T("codeAssistant.multiSelect")"
                              LoadingText="@T("common.loading")"
                              RenameText="@T("codeAssistant.renameSession")"
                              DeleteText="@T("common.delete")"
                              ShareSessionText="@T("codeAssistant.shareSession")"
                              NoSessionsText="@T("codeAssistant.noSessions")"
                              CreateSessionHintText="@T("codeAssistant.createSessionHint")"
                              OnClose="CloseSidePanel"
                              OnCreateNewSession="CreateNewSession"
                              OnToggleMultiSelect="ToggleSessionMultiSelectMode"
                              OnToggleSelectAll="ToggleSelectAllSessions"
                              OnShowBatchDelete="ShowBatchSessionDeleteDialog"
                              OnSessionSelected="LoadSession"
                              OnToggleSessionSelection="ToggleSessionSelection"
                              OnShareSession="ShowShareDialog"
                              OnRenameSession="ShowRenameDialog"
                              OnDeleteSession="ShowDeleteDialog"
                              GetSessionItemClass="GetSessionItemClass"
                              FormatDateTime="FormatDateTime" />
        </SessionsContent>
        <ContextContent>
            <div class="h-full">
                <ContextPreviewPanel @ref="_contextPreviewPanel"
                                     Embedded="true"
                                     ShowHeader="false"
                                     IsActive="@(_activeMenuItem == "context")"
                                     SessionId="@_sessionId"
                                     OnContextChanged="OnContextChanged" />
            </div>
        </ContextContent>
        <SettingsContent>
            @RenderSettingsPanel()
        </SettingsContent>
    </SidePanel>

    <!-- 移动端会话列表面板 (保持原有行为) -->
    <SessionListPanel Show="@(_showSessionList && !_showSidePanel)"
                      Sessions="@_sessions"
                      SelectedSessionIds="@_selectedSessionIds"
                      IsMultiSelectMode="@_isSessionMultiSelectMode"
                      IsLoadingSessions="@_isLoadingSessions"
                      IsLoadingSession="@_isLoadingSession"
                      CurrentSessionId="@(_currentSession?.SessionId ?? string.Empty)"
                      TitleText="@T("codeAssistant.sessionHistory")"
                      CloseText="@T("common.close")"
                      DeselectAllText="@T("codeAssistant.deselectAll")"
                      SelectAllText="@T("common.selectAll")"
                      BatchDeleteText="@T("codeAssistant.batchDelete")"
                      CancelText="@T("common.cancel")"
                      NewSessionText="@T("codeAssistant.newSession")"
                      MultiSelectText="@T("codeAssistant.multiSelect")"
                      LoadingText="@T("common.loading")"
                      RenameText="@T("codeAssistant.renameSession")"
                      DeleteText="@T("common.delete")"
                      ShareSessionText="@T("codeAssistant.shareSession")"
                      NoSessionsText="@T("codeAssistant.noSessions")"
                      CreateSessionHintText="@T("codeAssistant.createSessionHint")"
                      OnClose="ToggleSessionList"
                      OnCreateNewSession="CreateNewSession"
                      OnToggleMultiSelect="ToggleSessionMultiSelectMode"
                      OnToggleSelectAll="ToggleSelectAllSessions"
                      OnShowBatchDelete="ShowBatchSessionDeleteDialog"
                      OnSessionSelected="LoadSession"
                      OnToggleSessionSelection="ToggleSessionSelection"
                      OnShareSession="ShowShareDialog"
                      OnRenameSession="ShowRenameDialog"
                      OnDeleteSession="ShowDeleteDialog"
                      GetSessionItemClass="GetSessionItemClass"
                      FormatDateTime="FormatDateTime" />

    <!-- 右侧预览区 -->
    <div id="code-assistant-preview-panel" class="flex flex-1 bg-white/60 backdrop-blur-sm p-6 flex-col overflow-hidden min-w-[420px] transition-all duration-300 relative">
        <PreviewTabsHeader ActiveTabKey="@_activeTabKey"
                           ActiveTabKeyChanged="@((string key) => _activeTabKey = key)"
                           ActiveTabClass="border-blue-500 text-blue-700 bg-blue-50/50 shadow-sm"
                           InactiveTabClass="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50"
                           OutputText="@T("codeAssistant.outputResult")"
                           WorkspaceText="@T("codeAssistant.workspaceFiles")"
                           HtmlText="@T("codeAssistant.htmlPreview")" />

        <!-- 进度追踪器（全局显示，不受标签页影响，移动端隐藏） -->
        <div class="mb-3">
            <ProgressTracker @ref="_progressTracker" CanCancel="true" OnCancel="CancelExecution" />
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-hidden min-w-0">
            @if (_activeTabKey == "1")
            {
                <!-- 输出结果 -->
                <OutputResultPanel 
                    ContainerId="output-container"
                    HasOutputEvents="@(_isJsonlOutputActive && _jsonlEvents.Any())"
                    TotalEventCount="@_jsonlEvents.Count"
                    DisplayedEventCount="@Math.Min(_displayedEventCount, _jsonlEvents.Count)"
                    InitialDisplayCount="@InitialDisplayCount"
                    ActiveThreadId="@_activeThreadId"
                    HasMoreEvents="@_hasMoreEvents"
                    IsLoading="@_isLoading"
                    EventGroups="@ConvertToOutputEventGroups(GetPagedJsonlEventGroups())"
                    RawOutput="@_rawOutput"
                    EmptyTitle="@T("codeAssistant.noOutput")"
                    EmptyDescription="@T("codeAssistant.executeCode")"
                    CopyLabel="@T("common.copy")"
                    OnLoadMore="LoadMoreEvents"
                    OnToggleGroupCallback="HandleToggleGroup"
                    IsGroupOpenFunc="@(g => IsJsonlGroupOpen(ConvertToJsonlGroup(g)))"
                    OnAnswerQuestion="HandleAnswerQuestion" />
            }
            else if (_activeTabKey == "2")
            {
                <WorkspaceTabPanel Show="true"
                                   SubTab="@_workspaceSubTab"
                                   OnSubTabChanged="@((string key) => _workspaceSubTab = key)"
                                   FilesTabText="@T("codeAssistant.fileTree")"
                                   HistoryTabText="@T("codeAssistant.versionHistory")"
                                   DiffTabText="@T("codeAssistant.fileDiff")"
                                   MonitorTabText="@T("codeAssistant.fileMonitor")"
                                   SearchTabText="@T("codeAssistant.fileSearch")"
                                   GetSubTabClass="GetWorkspaceSubTabClass">
                    <FilesContent>
                        <WorkspaceFileTreePanel HasWorkspaceFiles="@(_workspaceFiles != null && _workspaceFiles.Any())"
                                               IsUploading="@_isUploading"
                                               SelectedFilesCount="@_selectedFiles.Count"
                                               HasMoreNodes="@_hasMoreNodes"
                                               RemainingNodesCount="@((_workspaceFiles?.Count ?? 0) - _currentVisibleNodes)"
                                               WorkspaceFilesText="@T("codeAssistant.workspaceFiles")"
                                               CreateFolderText="@T("codeAssistant.createFolder")"
                                               UploadText="@T("common.upload")"
                                               DownloadAllText="下载全部"
                                               DownloadShortText="下载"
                                               NoWorkspaceText="@T("codeAssistant.noWorkspace")"
                                               StartConversationText="@T("codeAssistant.startConversation")"
                                               MoveText="移动"
                                               CopyText="@T("common.copy")"
                                               DeleteText="@T("common.delete")"
                                               CancelText="@T("common.cancel")"
                                               SelectAllText="@T("common.selectAll")"
                                               SelectedItemsTextFactory="@((int count) => $"已选择 {count} 项")"
                                               LoadMoreTextFactory="@((int count) => $"加载更多 ({count} 项)")"
                                               OnShowCreateFolder="ShowCreateFolderDialog"
                                               OnFileUpload="HandleFileUpload"
                                               OnDownloadAll="DownloadAllFiles"
                                               OnToggleSelectAll="ToggleSelectAll"
                                               OnClearSelection="@(() => _selectedFiles.Clear())"
                                               OnBatchOperation="ShowBatchOperationDialog"
                                               OnLoadMoreNodes="LoadMoreNodes"
                                               OnScroll="OnFileTreeScroll">
                            <FileNodes>
                                @foreach (var file in GetVisibleNodes(_workspaceFiles ?? new List<WorkspaceFileNode>()))
                                {
                                    @RenderFileNode(file, 0)
                                }
                            </FileNodes>
                        </WorkspaceFileTreePanel>
                    </FilesContent>
                    <HistoryContent>
                        <VersionHistoryPanel SessionId="@_sessionId" OnCompareToCurrent="HandleCompareRequest" />
                    </HistoryContent>
                    <DiffContent>
                        <DiffViewerPanel SessionId="@_sessionId"
                                        InitialFilePath="@_diffFilePath"
                                        InitialFromCommit="@_diffFromCommit"
                                        InitialToCommit="@_diffToCommit" />
                    </DiffContent>
                    <MonitorContent>
                        <FileMonitorPanel SessionId="@_sessionId" />
                    </MonitorContent>
                    <SearchContent>
                        <FileSearchPanel SessionId="@_sessionId" />
                    </SearchContent>
                </WorkspaceTabPanel>
            }
            else if (_activeTabKey == "3")
            {
                <HtmlPreviewPanel SelectedHtmlFile="@_selectedHtmlFile"
                                 DetectedFrontendProjects="@_detectedFrontendProjects"
                                 AvailablePreviewRoots="@_availablePreviewRoots"
                                 PreviewRootPath="@_previewRootPath"
                                 ShowPreviewRootSelector="@_showPreviewRootSelector"
                                 SelectedPreviewMode="@_selectedPreviewMode"
                                 SelectedFrontendProject="@_selectedFrontendProject"
                                 IsServerStarting="@_isServerStarting"
                                 CurrentDevServer="@_currentDevServer"
                                 HtmlPreviewUrl="@_htmlPreviewUrl"
                                 OnTogglePreviewRootSelector="TogglePreviewRootSelector"
                                 OnSetPreviewRootPath="SetPreviewRootPath"
                                 OnStartPreview="StartPreview"
                                 OnStopServer="StopCurrentServer"
                                 OnOpenHtmlInNewWindow="OpenHtmlInNewWindow"
                                 OnRefreshPreview="RefreshHtmlPreview"
                                 ProjectTypeNameFactory="@(proj => FrontendProjectDetector.GetProjectTypeName(proj.Type))"
                                 SelectHtmlHintText="@T("codeAssistant.selectHtmlFromWorkspaceHint")"
                                 PreviewRootPathText="@T("codeAssistant.previewRootPath")"
                                 ChangePreviewRootText="@T("codeAssistant.changePreviewRoot")"
                                 ResetToWorkspaceRootText="@T("codeAssistant.resetToWorkspaceRoot")"
                                 SelectPreviewRootText="@T("codeAssistant.selectPreviewRoot")"
                                 WorkspaceRootText="@T("codeAssistant.workspaceRoot")"
                                 FrontendPreviewText="@T("codeAssistant.frontendProjectPreview")"
                                 PreviewModeStaticText="@T("codeAssistant.previewModeStatic")"
                                 PreviewModeDevText="@T("codeAssistant.previewModeDev")"
                                 PreviewModeBuildText="@T("codeAssistant.previewModeBuild")"
                                 ServerStartingText="@T("codeAssistant.serverStarting")"
                                 StopServerText="@T("codeAssistant.stopServer")"
                                 StartPreviewText="@T("codeAssistant.startPreview")"
                                 ServerRunningText="@T("codeAssistant.serverRunning")"
                                 PortText="@T("codeAssistant.port")"
                                 NoFrontendProjectsFoundText="@T("codeAssistant.noFrontendProjectsFound")"
                                 TryChangePreviewRootText="@T("codeAssistant.tryChangePreviewRoot")"
                                 PreviewText="@T("codeAssistant.preview")"
                                 OpenInNewTabText="@T("codeAssistant.openInNewTab")"
                                 RefreshText="@T("common.refresh")" />
            }
        </div>
    </div>
   
    <!-- PC 端拖拽分隔条 -->
    <div id="code-assistant-splitter" class="flex w-1 bg-gray-200 hover:bg-gray-300 active:bg-gray-400 cursor-col-resize transition-colors" role="separator" aria-orientation="vertical"></div>

    <!-- 左侧聊天区 -->
    <div id="code-assistant-chat-panel" class="flex-shrink-0 bg-white/80 backdrop-blur-sm p-6 border-r border-gray-200 flex flex-col overflow-hidden shadow-lg transition-all duration-300" style="@GetChatPanelStyle()">
        <UserInfoPanel Show="@_showUserInfo"
                       AvailableTools="@_availableTools"
                       SelectedToolId="@_selectedToolId"
                       SelectedToolIdChanged="@((string value) => _selectedToolId = value)"
                       OnToolChanged="OnToolChanged"
                       GitHubUrl="https://github.com/shuyu-labs/WebCode"
                       GitHubTitle="@T("codeAssistant.visitGitHub")"
                       GitHubText="GitHub"
                       ClearChatText="@T("codeAssistant.clearChat")"
                       OnClearChat="ClearChat" />
        <ChatToolbarPanel SessionHistoryTitle="@T("codeAssistant.sessionHistory")"
                          SessionHistoryText="@T("codeAssistant.sessionHistory")"
                          ProjectTitle="@T("project.title")"
                          ProjectText="@T("project.title")"
                          ContextTitle="@T("codeAssistant.contextManagement")"
                          ContextText="@T("codeAssistant.contextManagement")"
                          ClearChatText="@T("codeAssistant.clearChat")"
                          ShowSessionButton="false"
                          ShowProjectButton="false"
                          ShowContextButton="false"
                          ShowClearChatButton="false"
                          OnToggleSessionList="ToggleSessionList"
                          OnShowProjectManage="ShowProjectManageModal"
                          OnToggleContext="ToggleContextPanel"
                          OnClearChat="ClearChat" />

        <!-- 快捷操作面板 -->
        <QuickActionsPanel @ref="_quickActionsPanel" OnActionSelected="OnQuickActionSelected" />

        <ChatMessageListPanel Messages="@_messages"
                              IsLoading="@_isLoading"
                              CurrentAssistantMessage="@_currentAssistantMessage"
                              UserLabel="@T("codeAssistant.user")"
                              AssistantLabel="@T("codeAssistant.assistant")"
                              ThinkingText="@T("codeAssistant.thinking")"
                              CopyMessageLabel="@T("common.copyMessage")"
                              CopiedLabel="@T("common.copied")"
                              FullscreenLabel="@T("common.fullscreen")"
                              ExitFullscreenLabel="@T("common.exitFullscreen")"
                              IsJsonlContent="IsJsonlContent"
                              RenderJsonlContent="RenderJsonlContent"
                              RenderMarkdown="RenderMarkdown" />

        <ChatInputPanel UploadFileText="@T("codeAssistant.uploadFile")"
                        RootFolderText="@T("codeAssistant.rootFolder")"
                        UploadToWorkspaceTitle="@T("codeAssistant.uploadToWorkspace")"
                        SelectFileText="@T("codeAssistant.selectFile")"
                        InputPlaceholder="@T("codeAssistant.inputPlaceholder")"
                        SelectSkillText="@T("codeAssistant.selectSkill")"
                        FilterText="@T("codeAssistant.filter")"
                        NoMatchingSkillsText="@T("codeAssistant.noMatchingSkills")"
                        SendText="@T("codeAssistant.send")"
                        InputMessage="@_inputMessage"
                        InputMessageChanged="@((string value) => _inputMessage = value)"
                        OnAfterInput="HandleInput"
                        OnKeyDown="HandleKeyDown"
                        PreventDefaultOnEnter="@_isKeyDownEnterWithoutShift"
                        IsLoading="@_isLoading"
                        IsUploading="@_isUploading"
                        SelectedUploadFolder="@_selectedUploadFolder"
                        SelectedUploadFolderChanged="@((string value) => _selectedUploadFolder = value)"
                        AvailableFolders="@_availableFolders"
                        OnFileUpload="HandleFileUpload"
                        ShowSkillPicker="@_showSkillPicker"
                        FilteredSkills="@GetFilteredSkills()"
                        AllSkillsCount="@_skills.Count"
                        SkillFilter="@_skillFilter"
                        CurrentToolBadgeClass="@GetCurrentToolBadgeClass()"
                        CurrentToolName="@GetCurrentToolName()"
                        SkillIconColor="@(skill => GetSkillIconColor(skill.Source))"
                        SkillBadgeClass="@(skill => GetSkillBadgeClass(skill.Source))"
                        OnSelectSkill="SelectSkill"
                        InputLengthText="@string.Format("{0} / 5000", _inputMessage?.Length ?? 0)"
                        OnSendMessage="SendMessage">
            <AutoCompleteContent>
                <AutoCompleteDropdown @ref="_autoCompleteDropdown" OnSuggestionSelected="OnSuggestionSelected" TargetElementId="input-message" />
            </AutoCompleteContent>
        </ChatInputPanel>
    </div>

  
</div>

<!-- 环境变量配置模态框 -->
<EnvironmentVariableConfigModal @ref="_envConfigModal" />

<!-- 代码预览模态框 -->
@* 代码预览模态框 (已应用Tailwind样式) *@
<CodePreviewModal @ref="_codePreviewModal" />

<CreateFolderDialog Show="@_showCreateFolderDialog"
                    Title="@T("codeAssistant.createFolder")"
                    FolderNameLabel="@T("codeAssistant.folderName")"
                    FolderNamePlaceholder="@T("codeAssistant.folderNamePlaceholder")"
                    FolderNameHint="@T("codeAssistant.folderNameHint")"
                    CancelText="@T("common.cancel")"
                    CreateText="@T("codeAssistant.create")"
                    CreatingText="@T("codeAssistant.creating")"
                    ErrorMessage="@_createFolderError"
                    FolderName="@_newFolderName"
                    FolderNameChanged="@((string value) => _newFolderName = value)"
                    IsCreating="@_isCreatingFolder"
                    OnClose="CloseCreateFolderDialog"
                    OnCreate="CreateFolder"
                    OnKeyDown="HandleCreateFolderKeyDown" />

<DeleteWorkspaceItemDialog Show="@_showDeleteConfirmDialog"
                           Title="@T("codeAssistant.confirmDelete")"
                           WarningText="@(_nodeToDelete == null ? string.Empty : T("codeAssistant.deleteWarning", ("type", _nodeToDelete.Type == "folder" ? T("codeAssistant.folder") : T("codeAssistant.file"))))"
                           FolderDeleteWarningText="@T("codeAssistant.folderDeleteWarning")"
                           CannotUndoText="@T("codeAssistant.cannotUndo")"
                           CancelText="@T("common.cancel")"
                           ConfirmText="@T("codeAssistant.confirmDelete")"
                           DeletingText="@T("codeAssistant.deleting")"
                           ErrorMessage="@_deleteError"
                           ItemPath="@(_nodeToDelete?.Path ?? string.Empty)"
                           IsFolder="@(_nodeToDelete?.Type == "folder")"
                           IsDeleting="@_isDeleting"
                           OnClose="CloseDeleteConfirmDialog"
                           OnConfirm="DeleteWorkspaceItem" />

@code {
    private RenderFragment RenderFileNode(WorkspaceFileNode node, int depth) => __builder =>
    {
        var paddingLeft = depth * 12; // 减小移动端缩进
        var nodeKey = NormalizePath(node.Path); // 使用完整路径作为唯一标识
        
        <div @key="@nodeKey" style="padding-left: @(paddingLeft)px" class="py-0.5">
            @if (node.Type == "folder")
            {
                var normalizedPath = nodeKey;
                var isExpanded = _expandedFolders.Contains(normalizedPath);
                <div class="group flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm font-semibold hover:bg-gray-100 rounded-lg px-2 sm:px-3 py-1.5 sm:py-2 transition-colors active:bg-gray-200">
                    <div class="flex items-center gap-1.5 sm:gap-2 flex-1 cursor-pointer min-w-0"
                         @onclick="() => ToggleFolder(node)">
                        <!-- 展开/折叠箭头 -->
                        <svg class="@(isExpanded ? "rotate-90" : "") w-3 h-3 text-gray-500 flex-shrink-0 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- 文件夹图标 -->
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-yellow-500 group-hover:text-yellow-600 flex-shrink-0 transition-colors" fill="currentColor" viewBox="0 0 20 20">
                            @if (isExpanded)
                            {
                                <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                            }
                            else
                            {
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a2 2 0 00-2 2v5a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                            }
                        </svg>
                        <span class="group-hover:text-gray-800 transition-colors truncate">@node.Name</span>
                    </div>
                    <div class="flex sm:hidden items-center gap-0.5 flex-shrink-0">
                        <button @onclick="() => ShowDeleteConfirmDialog(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-red-100 active:bg-red-200 rounded-lg transition-colors"
                                title="@T("codeAssistant.deleteFolder")">
                            <svg class="w-3.5 h-3.5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="hidden sm:group-hover:flex items-center gap-1 flex-shrink-0">
                        <button @onclick="() => ShowDeleteConfirmDialog(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-red-100 rounded-lg transition-colors"
                                title="@T("codeAssistant.deleteFolder")">
                            <svg class="w-3.5 h-3.5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                @if (node.Children != null && isExpanded)
                {
                    foreach (var child in node.Children)
                    {
                        @RenderFileNode(child, depth + 1)
                    }
                }
            }
            else
            {
                var fileIcon = GetFileIcon(node.Extension);
                <div class="group flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm hover:bg-gradient-to-r hover:bg-gray-50 rounded-lg px-2 sm:px-3 py-1.5 sm:py-2 transition-all active:bg-gray-200">
                    <input type="checkbox" 
                           checked="@_selectedFiles.Contains(node.Path)" 
                           @onchange="() => ToggleFileSelection(node.Path)"
                           @onclick:stopPropagation="true"
                           class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0" />
                    @((MarkupString)fileIcon)
                    <span class="flex-1 cursor-pointer group-hover:text-gray-800 group-hover:font-medium transition-all truncate min-w-0" @onclick="() => OnFileNodeClick(node)">@node.Name</span>
                    @if (node.IsHtml)
                    {
                        <span class="px-1.5 sm:px-2.5 py-0.5 bg-gradient-to-r from-green-100 to-green-200 text-green-800 text-[10px] sm:text-xs rounded-full font-semibold shadow-sm flex-shrink-0">HTML</span>
                    }
                    <div class="flex sm:hidden items-center gap-0.5 flex-shrink-0">
                        <button @onclick="async () => await PreviewFile(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-gray-100 active:bg-gray-200 rounded-lg transition-colors"
                                title="@T("codeAssistant.previewCode")">
                            <svg class="w-3.5 h-3.5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                        <button @onclick="() => DownloadFile(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-gray-100 active:bg-gray-200 rounded-lg transition-colors"
                                title="@T("codeAssistant.downloadFile")">
                            <svg class="w-3.5 h-3.5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                        <button @onclick="() => ShowDeleteConfirmDialog(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-red-100 active:bg-red-200 rounded-lg transition-colors"
                                title="@T("codeAssistant.deleteFile")">
                            <svg class="w-3.5 h-3.5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="hidden sm:group-hover:flex items-center gap-1 flex-shrink-0">
                        <button @onclick="async () => await PreviewFile(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors"
                                title="@T("codeAssistant.previewCode")">
                            <svg class="w-3.5 h-3.5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                        <button @onclick="() => DownloadFile(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors"
                                title="@T("codeAssistant.downloadFile")">
                            <svg class="w-3.5 h-3.5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                        <button @onclick="() => ShowDeleteConfirmDialog(node)"
                                @onclick:stopPropagation="true"
                                class="p-1.5 hover:bg-red-100 rounded-lg transition-colors"
                                title="@T("codeAssistant.deleteFile")">
                            <svg class="w-3.5 h-3.5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            }
        </div>
    };

    private string GetTabClass(string tabKey)
    {
        return _activeTabKey == tabKey
            ? "border-blue-500 text-blue-700 bg-blue-50/50 shadow-sm"
            : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50";
    }

    private string GetFileIcon(string extension)
    {
        return FileIconHelper.GetFileIcon(extension);
    }

    // SidePanel 设置内容渲染
    private RenderFragment RenderSettingsPanel() => __builder =>
    {
        <div class="p-4 space-y-3">
            <!-- 用户头像和信息 -->
            <div class="flex items-center gap-3 px-3 py-3 bg-gray-50 rounded-lg border border-gray-100">
                <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs text-gray-500 font-medium">@T("codeAssistant.currentUser")</div>
                    <div class="text-sm font-semibold text-gray-800 truncate">@_currentUsername</div>
                </div>
            </div>
            
            <!-- 语言切换 -->
            <div class="px-3 py-2.5 bg-white rounded-lg border border-gray-100">
                <div class="flex items-center gap-3 mb-2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                    </svg>
                    <div class="text-sm font-medium text-gray-700">@T("codeAssistant.language")</div>
                </div>
                <div class="language-switcher-container">
                    <LanguageSwitcher OnLanguageChanged="OnLanguageChangedFromSidePanel" />
                </div>
            </div>
            
            <!-- 环境变量配置 -->
            <button @onclick="OpenEnvConfigFromSidePanel" 
                    class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition-colors text-left">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700">@T("codeAssistant.settings")</div>
                    <div class="text-xs text-gray-400">@T("settings.envConfig")</div>
                </div>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            
            <!-- 检查更新 -->
            <button @onclick="CheckForUpdateFromSidePanel" 
                    class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition-colors text-left">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700">@T("version.checkUpdate")</div>
                    <div class="text-xs text-gray-400">@T("version.currentVersion"): @_currentVersion</div>
                </div>
                @if (_hasUpdate)
                {
                    <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">@T("version.newVersion")</span>
                }
            </button>
            
            <!-- 访问官网 -->
            <a href="https://wc.tree456.com/" target="_blank" rel="noopener noreferrer"
               class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition-colors text-left">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                </svg>
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700">@T("settings.visitWebsite")</div>
                    <div class="text-xs text-gray-400">wc.tree456.com</div>
                </div>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
            
            <!-- 退出登录 -->
            <div class="pt-3 border-t border-gray-100">
                <button @onclick="HandleLogoutFromSidePanel" 
                        class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-red-50 rounded-lg transition-colors text-left">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <div class="text-sm font-medium text-red-600">@T("codeAssistant.logout")</div>
                </button>
            </div>
        </div>
    };

}

<SessionDeleteDialog Show="@_showSessionDeleteDialog"
                     Session="@_sessionToDelete"
                     Title="@T("codeAssistant.sessionDeleteTitle")"
                     ConfirmMessage="@T("codeAssistant.sessionDeleteConfirmMessage")"
                     MessageCountText="@(_sessionToDelete == null ? string.Empty : T("codeAssistant.sessionDeleteMessageCount", ("count", _sessionToDelete.Messages.Count.ToString())))"
                     CreatedAtText="@(_sessionToDelete == null ? string.Empty : T("codeAssistant.sessionDeleteCreatedAt", ("time", _sessionToDelete.CreatedAt.ToString("yyyy-MM-dd HH:mm"))))"
                     UpdatedAtText="@(_sessionToDelete == null ? string.Empty : T("codeAssistant.sessionDeleteUpdatedAt", ("time", FormatDateTime(_sessionToDelete.UpdatedAt))))"
                     WarningText="@T("codeAssistant.sessionDeleteWarning")"
                     CurrentSessionTitle="@T("codeAssistant.sessionDeleteCurrentTitle")"
                     CurrentSessionNote="@T("codeAssistant.sessionDeleteCurrentNote")"
                     CancelText="@T("common.cancel")"
                     ConfirmText="@T("codeAssistant.sessionDeleteConfirmText")"
                     DeletingText="@T("codeAssistant.sessionDeleteDeletingText")"
                     ErrorMessage="@_sessionDeleteError"
                     IsDeleting="@_isDeletingSession"
                     IsCurrentSession="@(_currentSession?.SessionId == _sessionToDelete?.SessionId)"
                     OnClose="CloseSessionDeleteDialog"
                     OnConfirm="DeleteSession" />

<BatchSessionDeleteDialog Show="@_showBatchSessionDeleteDialog"
                          SelectedSessions="@GetSelectedSessions()"
                          Title="@T("codeAssistant.batchDeleteConfirm")"
                          MessageText="@T("codeAssistant.batchDeleteMessage", ("count", _selectedSessionIds.Count.ToString()))"
                          WarningText="@T("codeAssistant.batchDeleteWarning")"
                          CancelText="@T("common.cancel")"
                          ConfirmText="@T("codeAssistant.confirmBatchDelete", ("count", _selectedSessionIds.Count.ToString()))"
                          DeletingText="@T("codeAssistant.deleting")"
                          ErrorMessage="@_batchSessionDeleteError"
                          CurrentSessionId="@(_currentSession?.SessionId ?? string.Empty)"
                          CurrentSessionBadgeText="@T("codeAssistant.currentSession")"
                          IncludesCurrentTitle="@T("codeAssistant.includesCurrentSession")"
                          IncludesCurrentNote="@T("codeAssistant.currentSessionDeleteNote")"
                          IncludesCurrentSession="@GetSelectedSessions().Any(s => _currentSession?.SessionId == s.SessionId)"
                          IsDeleting="@_isDeletingBatchSessions"
                          SessionMetaTextFactory="@((SessionHistory session) => string.Format("{0} {1} • {2}", session.Messages.Count, T("codeAssistant.messagesCount"), FormatDateTime(session.UpdatedAt)))"
                          OnClose="CloseBatchSessionDeleteDialog"
                          OnConfirm="DeleteSelectedSessions" />

<RenameSessionDialog Show="@(_showRenameDialog && _sessionToRename != null)"
                    Title="@T("codeAssistant.renameDialogTitle")"
                    LabelText="@T("codeAssistant.renameDialogLabel")"
                    Placeholder="@T("codeAssistant.renameDialogPlaceholder")"
                    HintText="@T("codeAssistant.renameDialogHint")"
                    CurrentLengthText="@($"{_newSessionTitle?.Length ?? 0} / 100")"
                    CancelText="@T("codeAssistant.renameDialogCancel")"
                    SaveText="@T("codeAssistant.renameDialogSave")"
                    SavingText="@T("codeAssistant.renameDialogSaving")"
                    ErrorMessage="@_renameError"
                    SessionTitle="@_newSessionTitle"
                    SessionTitleChanged="@((string value) => _newSessionTitle = value)"
                    IsSaving="@_isRenamingSession"
                    InputClass="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-gray-600 focus:ring-2 focus:ring-gray-300 transition-all outline-none text-sm"
                    OnClose="CloseRenameDialog"
                    OnConfirm="RenameSession"
                    OnKeyDown="HandleRenameKeyDown" />

<!-- 批量操作对话框 -->
<BatchOperationDialog Show="@_showBatchOperationDialog"
                      Operation="@_batchOperation"
                      SelectedFiles="@_selectedFiles"
                      TargetFolder="@_batchTargetFolder"
                      IsOperating="@_isBatchOperating"
                      ErrorMessage="@_batchOperationError"
                      OnClose="CloseBatchOperationDialog"
                      OnConfirm="ExecuteBatchOperation" />

<TemplateVariableInputDialog Show="@_showVariableInputDialog"
                             Template="@_templateWithVariables"
                             Values="@_variableValues"
                             Title="@T("codeAssistant.templateVariableTitle")"
                             TemplateLabel="@T("codeAssistant.templateVariableTemplateLabel")"
                             VariableCountText="@(_templateWithVariables == null ? string.Empty : T("codeAssistant.templateVariableCountText", ("count", _templateWithVariables.Variables.Count.ToString())))"
                             ValuePlaceholderFormat="@T("codeAssistant.templateVariableValuePlaceholder")"
                             CancelText="@T("common.cancel")"
                             ConfirmText="@T("codeAssistant.templateVariableConfirmText")"
                             DisableConfirm="@_variableValues.Any(v => string.IsNullOrWhiteSpace(v.Value))"
                             OnClose="CloseVariableInputDialog"
                             OnConfirm="ApplyTemplateWithVariables" />

<!-- 会话分享模态框 -->
<ShareSessionModal @ref="_shareSessionModal" SessionId="@_sessionId" />

<!-- 项目管理模态框 -->
<ProjectManageModal @ref="_projectManageModal" OnProjectsChanged="OnProjectsChanged" />

<!-- 项目选择模态框 -->
<ProjectSelectModal @ref="_projectSelectModal" OnProjectSelected="OnProjectSelected" />

<!-- 更新提示模态框 -->
<UpdateNotificationModal @ref="_updateNotificationModal" />

<!-- 模板库模态框（通过左侧菜单直接打开） -->
<TemplateLibraryModal @ref="_templateLibraryModal"
                      ShowButton="false"
                      OnTemplateSelected="OnTemplateSelected" />
