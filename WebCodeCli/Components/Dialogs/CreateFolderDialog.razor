@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@implements IAsyncDisposable

@if (Show)
{
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @onclick="OnClose">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                    </svg>
                    @Title
                </h3>
                <button @onclick="OnClose" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="mb-4 bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded-lg" role="alert">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="block text-sm">@ErrorMessage</span>
                    </div>
                </div>
            }

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">@FolderNameLabel</label>
                <input @bind-value="FolderName"
                       @bind-value:event="oninput"
                       @bind-value:after="HandleFolderNameInputAfterBind"
                       @onkeydown="HandleKeyDownInternal"
                       @onkeydown:preventDefault="@(ShouldPreventDefault())"
                       id="create-folder-input"
                       type="text"
                       placeholder="@FolderNamePlaceholder"
                       class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-500 text-sm bg-white shadow-sm"
                       autofocus />
                <p class="mt-2 text-xs text-gray-500">
                    @FolderNameHint
                </p>
            </div>

            <div class="flex gap-3">
                <button @onclick="OnClose"
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors shadow-sm">
                    @CancelText
                </button>
                <button @onclick="OnCreate"
                        disabled="@(string.IsNullOrWhiteSpace(FolderName) || IsCreating)"
                        class="flex-1 px-4 py-3 bg-gray-800 hover:bg-black text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                    @if (IsCreating)
                    {
                        <div class="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent"></div>
                        <span>@CreatingText</span>
                    }
                    else
                    {
                        <span>@CreateText</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string FolderNameLabel { get; set; } = string.Empty;
    [Parameter] public string FolderNamePlaceholder { get; set; } = string.Empty;
    [Parameter] public string FolderNameHint { get; set; } = string.Empty;
    [Parameter] public string CancelText { get; set; } = string.Empty;
    [Parameter] public string CreateText { get; set; } = string.Empty;
    [Parameter] public string CreatingText { get; set; } = string.Empty;
    [Parameter] public string ErrorMessage { get; set; } = string.Empty;
    [Parameter] public string FolderName { get; set; } = string.Empty;
    [Parameter] public bool IsCreating { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnCreate { get; set; }
    [Parameter] public EventCallback<KeyboardEventArgs> OnKeyDown { get; set; }
    [Parameter] public EventCallback<string> FolderNameChanged { get; set; }

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private bool _isComposing;
    private DotNetObjectReference<CreateFolderDialog>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setupCompositionEvents", "create-folder-input", _dotNetRef);
        }
    }

    [JSInvokable]
    public void OnCompositionStart()
    {
        _isComposing = true;
    }

    [JSInvokable]
    public async Task OnCompositionEnd(string finalValue)
    {
        _isComposing = false;
        // 组合结束时同步最终值
        if (finalValue != FolderName)
        {
            await FolderNameChanged.InvokeAsync(finalValue);
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("disposeCompositionEvents", "create-folder-input");
        }
        catch
        {
            // 忽略释放阶段的 JS 错误
        }
        _dotNetRef?.Dispose();
    }

    private async Task HandleFolderNameInputAfterBind()
    {
        // 组合期间（中文输入法候选阶段）不触发更新，避免闪烁
        if (_isComposing)
        {
            return;
        }

        await FolderNameChanged.InvokeAsync(FolderName);
    }

    private Task HandleKeyDownInternal(KeyboardEventArgs args)
    {
        if (_isComposing)
        {
            return Task.CompletedTask;
        }

        return OnKeyDown.InvokeAsync(args);
    }

    private bool ShouldPreventDefault()
    {
        // 只在非组合期间才阻止默认行为
        return !_isComposing;
    }
}
